---
# GPG key management for The Bastion

- name: gpg | Install gnupg package
  ansible.builtin.package:
    name: gnupg
    state: present
  tags: bastion_gpg

# === Bastion GPG Key Management ===
# This key is used by the bastion to sign ttyrec files

- name: gpg | Check if bastion GPG key already exists
  ansible.builtin.stat:
    path: /etc/bastion/osh-encrypt-rsync.conf.d/50-gpg-bastion-key.conf
  register: bastion_gpg_key_exists
  tags: bastion_gpg

- name: gpg | Generate bastion GPG key
  ansible.builtin.command:
    cmd: "{{ bastion_install_dir }}/bin/admin/setup-gpg.sh --generate"
    creates: /etc/bastion/osh-encrypt-rsync.conf.d/50-gpg-bastion-key.conf
  when:
    - bastion_gpg_key_generate | bool
    - not bastion_gpg_key_exists.stat.exists
  register: bastion_gpg_generate_result
  tags: bastion_gpg

# === Admin GPG Key Management ===
# Import one or more admin public keys for encrypting backups and ttyrec files

- name: gpg | Validate admin GPG keys are provided
  ansible.builtin.fail:
    msg: "At least one admin GPG public key is required when GPG is enabled. Set bastion_admin_gpg_keys."
  when:
    - bastion_gpg_enabled | bool
    - bastion_admin_gpg_keys | length == 0
  tags: bastion_gpg

- name: gpg | Get admin GPG config file before import
  ansible.builtin.stat:
    path: /etc/bastion/osh-encrypt-rsync.conf.d/50-gpg-admins-key.conf
    get_checksum: true
  register: admin_gpg_config_before
  when: bastion_admin_gpg_keys | length > 0
  tags: bastion_gpg

- name: gpg | Import admin GPG public keys
  ansible.builtin.shell:
    cmd: |
      set -o pipefail && echo "{{ item }}" | {{ bastion_install_dir }}/bin/admin/setup-gpg.sh --import --overwrite
  loop: "{{ bastion_admin_gpg_keys }}"
  when:
    - bastion_admin_gpg_keys | length > 0
    - item | length > 0
  register: admin_gpg_import_results
  changed_when: false  # We'll determine this separately
  failed_when: >-
    admin_gpg_import_results.rc != 0 and
     'key you imported (did it exist already?)' not in (admin_gpg_import_results.stderr | default(''))
  tags: bastion_gpg

- name: gpg | Get admin GPG config file after import
  ansible.builtin.stat:
    path: /etc/bastion/osh-encrypt-rsync.conf.d/50-gpg-admins-key.conf
    get_checksum: true
  register: admin_gpg_config_after
  when: bastion_admin_gpg_keys | length > 0
  tags: bastion_gpg

- name: gpg | Determine if admin GPG config changed
  ansible.builtin.set_fact:
    admin_gpg_config_changed: >-
      {{
        (not admin_gpg_config_before.stat.exists and admin_gpg_config_after.stat.exists) or
        (admin_gpg_config_before.stat.exists and admin_gpg_config_after.stat.exists and
         admin_gpg_config_before.stat.checksum != admin_gpg_config_after.stat.checksum)
      }}
  when:
    - bastion_admin_gpg_keys | length > 0
    - admin_gpg_config_before is defined
    - admin_gpg_config_after is defined
  tags: bastion_gpg
